- hosts: k8s-control-plane-1
  gather_facts: no
  become: no
  vars:
    target_namespace: external-services
  tasks:

  # Create external-services namespace
    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition: 
          apiVersion: v1
          kind: Namespace
          metadata:
            name: '{{ target_namespace }}'

    - name: Create local wildcar certificate
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: Certificate
          metadata:
            name: local-jazziro-com-tls
            namespace: '{{ target_namespace }}'
          spec:
            secretName: local-jazziro-com-tls
            issuerRef:
              name: letsencrypt-production
              kind: ClusterIssuer
            commonName: "{{ local_dns_wildcard }}"
            dnsNames:
            - "{{ local_dns_wildcard }}"
    
    - name: Create webhook-site service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1  
          kind: Service
          metadata:
            name: webhook-site
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 8086
              protocol: TCP
              targetPort: 8086

    - name: Create webhook-site IngressRoute
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: webhook-site
            namespace: '{{ target_namespace }}'
            annotations:
              kubernetes.io/ingress.class: traefik
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`webhook.{{ local_dns }}`)
                kind: Rule
                services:
                  - name: webhook-site
                    kind: Service
                    port: 8086
            tls:
              secretName: local-jazziro-com-tls

  # Dockge external service and ingressroute
    - name: Create dockge service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: dockge
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 5001
              protocol: TCP
              targetPort: 5001

    - name: Create dockge IngressRoute
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: dockge
            namespace: '{{ target_namespace }}'
            annotations:
              kubernetes.io/ingress.class: traefik
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`dockge.{{ local_dns }}`)
                kind: Rule
                services:
                  - name: dockge
                    kind: Service
                    port: 5001
            tls:
              secretName: local-jazziro-com-tls

  # Proxmox external service and ingressroute
    - name: Create proxmox service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: proxmox
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.11
            ports:
            - name: https
              port: 8006
              protocol: TCP
              targetPort: 8006

    - name: Create proxmox IngressRoute
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: proxmox
            namespace: '{{ target_namespace }}'
            annotations:
              kubernetes.io/ingress.class: traefik
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`pve.{{ local_dns }}`)
                kind: Rule
                services:
                  - name: proxmox
                    kind: Service
                    port: 8006
            tls:
              secretName: local-jazziro-com-tls

  # HomeAssistant external service and ingressroute
    - name: Create homeassistant service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: homeassistant
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 8123
              protocol: TCP
              targetPort: 8123

    - name: Create homeassistant IngressRoute
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: homeassistant
            namespace: '{{ target_namespace }}'
            annotations:
              kubernetes.io/ingress.class: traefik
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`smarthome.{{ local_dns }}`)
                kind: Rule
                services:
                  - name: homeassistant
                    kind: Service
                    port: 8123
            tls:
              secretName: local-jazziro-com-tls

  # Pi-hole external service and ingressroute
    - name: Create pihole service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: pihole
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 80
              protocol: TCP
              targetPort: 80

    - name: Create pihole IngressRoute
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: pihole
            namespace: '{{ target_namespace }}'
            annotations:
              kubernetes.io/ingress.class: traefik
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`pihole.{{ local_dns }}`)
                kind: Rule
                services:
                  - name: pihole
                    kind: Service
                    port: 80
            tls:
              secretName: local-jazziro-com-tls

  # CloudBeaver external service and ingressroute
    - name: Create cloudbeaver service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: cloudbeaver
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 8978
              protocol: TCP
              targetPort: 8978

    - name: Create cloudbeaver IngressRoute
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: cloudbeaver
            namespace: '{{ target_namespace }}'
            annotations:
              kubernetes.io/ingress.class: traefik
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
          spec:
            entryPoints:
              - websecure
            routes:
              - match: Host(`cloudbeaver.{{ local_dns }}`)
                kind: Rule
                services:
                  - name: cloudbeaver
                    kind: Service
                    port: 8978
            tls:
              secretName: local-jazziro-com-tls

    - name: Create beszel service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: beszel
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 8090
              protocol: TCP
              targetPort: 8090
      tags: 
      - beszel

    - name: Create beszel ingress
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: beszel
            namespace: '{{ target_namespace }}'
            annotations:
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
              cert-manager.io/cluster-issuer: letsencrypt-production
          spec:
            ingressClassName: traefik
            tls:
            - hosts:
              - "beszel.{{ local_dns }}"
              secretName: local-jazziro-com-tls
            rules:
            - host: "beszel.{{ local_dns }}"
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: beszel
                      port:
                        number: 8090
      tags: 
      - beszel-ingress

# APi Gateway Example
    - name: Create transmission service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: transmission-direct
            namespace: '{{ target_namespace }}'
          spec:
            type: ClusterIP
            ports:
            - name: http
              port: 9091
              protocol: TCP
              targetPort: 9091
      tags:
      - transmission

    - name: Create transmission endpoints
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Endpoints
          metadata:
            name: transmission-direct
            namespace: '{{ target_namespace }}'
          subsets:
          - addresses:
            - ip: 192.168.0.21
            ports:
            - name: http
              port: 9091
              protocol: TCP
      tags:
      - transmission

    - name: Create Gateway for transmission
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: gateway.networking.k8s.io/v1
          kind: Gateway
          metadata:
            name: transmission
            namespace: "{{ target_namespace }}"
          spec:
            gatewayClassName: traefik
            listeners:
              - name: web
                protocol: HTTP
                port: 8000
                hostname: "transmission.{{ local_dns }}"
              - name: websecure
                protocol: HTTPS
                port: 8443
                hostname: "transmission.{{ local_dns }}"
                tls:
                  certificateRefs:
                    - name: local-jazziro-com-tls
      tags: 
      - transmission

    - name: Create HTTPRoute for transmission
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          metadata:
            name: transmission
            namespace: "{{ target_namespace }}"
          spec:
            parentRefs:
              - name: transmission
                sectionName: websecure
            hostnames:
              - "transmission.{{ local_dns }}"
            rules:
              - backendRefs:
                  - name: transmission-direct
                    port: 9091
      tags: 
      - transmission

# nginx proxy manager
    - name: Create nginx proxy manager service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: beszel
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.31
            ports:
            - name: http
              port: 8090
              protocol: TCP
              targetPort: 8090
      tags: 
      - npm

    - name: Create beszel ingress
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: beszel
            namespace: '{{ target_namespace }}'
            annotations:
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
              cert-manager.io/cluster-issuer: letsencrypt-production
          spec:
            ingressClassName: traefik
            tls:
            - hosts:
              - "beszel.{{ local_dns }}"
              secretName: local-jazziro-com-tls
            rules:
            - host: "beszel.{{ local_dns }}"
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: beszel
                      port:
                        number: 8090
      tags: 
      - npm

# TrueNAS
    - name: Create TrueNAS service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: nas
            namespace: '{{ target_namespace }}'
          spec:
            type: ExternalName
            externalName: 192.168.0.16
            ports:
            - name: http
              port: 80
              protocol: TCP
              targetPort: 80
      tags: 
      - truenas

    - name: Create TrueNAS ingress
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: nas
            namespace: '{{ target_namespace }}'
            annotations:
              external-dns.alpha.kubernetes.io/target: '{{ traefik_service_ip }}'
              cert-manager.io/cluster-issuer: letsencrypt-production
          spec:
            ingressClassName: traefik
            tls:
            - hosts:
              - "nas.{{ local_dns }}"
              secretName: local-jazziro-com-tls
            rules:
            - host: "nas.{{ local_dns }}"
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: nas
                      port:
                        number: 80
      tags: 
      - truenas